<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des Parkings et Restaurants</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* CSS précédent omis pour la concision */
    </style>
</head>
<body>
<header style="text-align: center;">
    <h1>QuickPark</h1>
</header>
<div class="container">
    <div class="header">
        <h1>Carte des Parkings et Restaurants</h1>
    </div>
    <div class="form-group">
        <label for="vehicleType">Type de véhicule :</label>
        <select id="vehicleType">
            <option value="car">Voiture</option>
            <option value="bike">Vélo</option>
            <option value="motorcycle">Moto</option>
        </select>
    </div>
    <div class="form-group">
        <label for="arriving">Date et heure d'arrivée :</label>
        <input type="datetime-local" id="arriving">
    </div>
    <div class="form-group">
        <label for="leaving">Date et heure de départ :</label>
        <input type="datetime-local" id="leaving">
    </div>
    <div class="form-group">
        <button id="fetchParkingsButton">Rechercher des parkings</button>
    </div>
    <div id="map"></div>
    <div class="form-group">
        <label for="cuisineType">Type de cuisine :</label>
        <select id="cuisineType">
            <option value="">Tous les types</option>
            <option value="French">Français</option>
            <option value="Italian">Italien</option>
            <option value="Japanese">Japonais</option>
            <option value="Mexican">Mexicain</option>
            <option value="Indian">Indien</option>
        </select>
    </div>
    <div class="form-group">
        <button id="fetchRestaurantsButton">Rechercher des restaurants</button>
        <button id="resetButton">Réinitialiser</button>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([48.8566, 2.3522], 13); // Paris coordinates

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    async function fetchParkings() {
        const vehicleType = document.getElementById('vehicleType').value;
        const arriving = document.getElementById('arriving').value;
        const leaving = document.getElementById('leaving').value;

        if (!arriving || !leaving) {
            alert('Veuillez saisir les dates et heures d\'arrivée et de départ');
            return;
        }

        try {
            const response = await fetch(`/api/parkings?vehicle_type=${vehicleType}&arriving=${arriving}&leaving=${leaving}`);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            data.locations.forEach(parking => {
                const marker = L.marker([parking.latitude, parking.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <b>${parking.name || 'Parking'}</b><br>
                        Adresse: ${parking.address || 'N/A'}<br>
                        Type: ${parking.type || 'N/A'}<br>
                        Tarif: ${parking.tariff || 'Non disponible'}<br>
                        <button onclick="reserveParking(${parking.id})">Réserver</button>
                    `);
            });
        } catch (error) {
            console.error('Error fetching parking data:', error);
            alert('Erreur lors de la récupération des données de parking. Veuillez vérifier la console pour plus de détails.');
        }
    }

    async function fetchRestaurants() {
        const cuisineType = document.getElementById('cuisineType').value;

        try {
            let url = '/api/restaurants';
            if (cuisineType) {
                url += `?cuisine_type=${cuisineType}`;
            }
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();

            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            data.restaurants.forEach(restaurant => {
                const marker = L.marker([restaurant.latitude, restaurant.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <b>${restaurant.name || 'Restaurant'}</b><br>
                        Adresse: ${restaurant.address || 'N/A'}<br>
                        Type de cuisine: ${restaurant.cuisine_type || 'N/A'}<br>
                        Note: ${restaurant.rating || 'N/A'}<br>
                    `);
            });
        } catch (error) {
            console.error('Error fetching restaurant data:', error);
            alert('Erreur lors de la récupération des données de restaurant. Veuillez vérifier la console pour plus de détails.');
        }
    }

    function reserveParking(parkingId) {
        const vehicleType = document.getElementById('vehicleType').value;
        const arriving = document.getElementById('arriving').value;
        const leaving = document.getElementById('leaving').value;

        console.log('Reserving parking:', { parkingId, vehicleType, arriving, leaving });

        fetch('/api/reserve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                parking_id: parkingId,
                vehicle_type: vehicleType,
                arriving: arriving,
                leaving: leaving
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            console.log('Reservation response:', data);
        })
        .catch(error => {
            console.error('Error reserving parking:', error);
            alert('Erreur lors de la réservation. Veuillez vérifier la console pour plus de détails.');
        });
    }

    document.getElementById('fetchParkingsButton').addEventListener('click', fetchParkings);
    document.getElementById('fetchRestaurantsButton').addEventListener('click', fetchRestaurants);
    document.getElementById('resetButton').addEventListener('click', function() {
        document.getElementById('vehicleType').value = 'car';
        document.getElementById('arriving').value = '';
        document.getElementById('leaving').value = '';
        document.getElementById('cuisineType').value = '';
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });
    });
</script>
</body>
</html>
